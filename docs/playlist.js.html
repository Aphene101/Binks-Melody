<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="utf-8">
    <title>JSDoc: Source: playlist.js</title>

    <script src="scripts/prettify/prettify.js"> </script>
    <script src="scripts/prettify/lang-css.js"> </script>
    <!--[if lt IE 9]>
      <script src="//html5shiv.googlecode.com/svn/trunk/html5.js"></script>
    <![endif]-->
    <link type="text/css" rel="stylesheet" href="styles/prettify-tomorrow.css">
    <link type="text/css" rel="stylesheet" href="styles/jsdoc-default.css">
</head>

<body>

<div id="main">

    <h1 class="page-title">Source: playlist.js</h1>

    



    
    <section>
        <article>
            <pre class="prettyprint source linenums"><code>/**
 * @file playlist.js
 * @description Handles rendering of individual playlists or genre-based playlists.
 * Supports:
 *  - Loading playlist data from Firestore
 *  - Loading top tracks by genre from Jamendo API
 *  - Rendering songs and wiring play events
 *  - Removing songs from user playlists
 *  - Forwarding "Add to playlist" actions to jamendo.js
 */

import { getTopTracksByTag } from "./jamendo.js";
import { db, auth } from "./firebase.js";
import {
  doc,
  getDoc,
  getDocs,
  collection,
  updateDoc,
  deleteDoc,
  arrayUnion,
} from "firebase/firestore";

const FALLBACK_IMG =
  "data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAQAAAC1HAwCAAAAC0lEQVR42mP8Xw8AAuMBgVdPxT8AAAAASUVORK5CYII=";

// Parse URL parameters to determine playlist or genre view
const params = new URLSearchParams(window.location.search);
const genre = params.get("genre");
let playlistId = params.get("id");
console.log("Playlist ID from URL:", playlistId);

// Redirect if no valid playlist or genre provided
if (!playlistId &amp;&amp; !genre) {
  alert("No playlist selected. Redirecting to playlists page.");
  window.location.href = "./playlists.html";
}

// DOM references
const backBtn = document.getElementById("pl-back") || null;
const nameEl = document.getElementById("pl-name") || null;
const iconEl = document.getElementById("pl-icon") || null;
const songsWrap = document.getElementById("pl-songs") || null;

/** @type {string|null} */
let currentUserId = null;
/** @type {Object|null} */
let currentTrack = null;

// Popup for song actions on the playlist page
const plSongPopup = document.createElement("div");
plSongPopup.className = "song-popup hidden";
plSongPopup.innerHTML = genre
  ? `
  &lt;div class="popup-item" id="pl-addToPlaylistBtn">
    &lt;img src="${import.meta.env.BASE_URL}Media/Purple-Add-Icon.svg" alt="Add">
    &lt;span>Add to Playlist&lt;/span>
  &lt;/div>
`
  : `
  &lt;div class="popup-item" id="pl-removeFromPlaylistBtn">
    &lt;img src="${import.meta.env.BASE_URL}Media/Delete-Icon.svg" alt="Remove">
    &lt;span>Remove from Playlist&lt;/span>
  &lt;/div>
`;
document.body.appendChild(plSongPopup);

/**
 * Open the "more actions" popup for a track.
 * @param {HTMLElement} anchorEl - Element used for positioning the popup.
 * @param {Object} track - The track object related to this row.
 */
function openMorePopup(anchorEl, track) {
  currentTrack = track;
  const rect = anchorEl.getBoundingClientRect();
  plSongPopup.style.top = `${rect.bottom + window.scrollY}px`;
  plSongPopup.style.left = `${rect.left + window.scrollX}px`;
  plSongPopup.classList.remove("hidden");
}

// Hide popup when clicking outside
document.addEventListener("click", (e) => {
  if (!plSongPopup.contains(e.target)) {
    plSongPopup.classList.add("hidden");
  }
});

/**
 * Remove a track from a Firestore playlist.
 * Supports both array-based and subcollection-based song storage.
 *
 * @async
 * @param {string} uid - User ID
 * @param {string} playlistId - Playlist document ID
 * @param {Object} track - Track object to remove
 * @returns {Promise&lt;void>}
 */
async function removeTrackFromPlaylist(uid, playlistId, track) {
  const playlistRef = doc(db, "users", uid, "playlists", playlistId);
  const snap = await getDoc(playlistRef);

  if (snap.exists() &amp;&amp; Array.isArray(snap.data().songs)) {
    const arr = snap.data().songs || [];
    const filtered = arr.filter(
      (s) => (s.id ?? s.audio) !== (track.id ?? track.audio)
    );
    await updateDoc(playlistRef, { songs: filtered });
  } else {
    if (track.id) {
      const songDoc = doc(
        db,
        "users",
        uid,
        "playlists",
        playlistId,
        "songs",
        track.id
      );
      await deleteDoc(songDoc);
    } else {
      const songsCol = collection(
        db,
        "users",
        uid,
        "playlists",
        playlistId,
        "songs"
      );
      const songsSnap = await getDocs(songsCol);
      const match = songsSnap.docs.find(
        (d) => (d.data().id ?? d.data().audio) === (track.id ?? track.audio)
      );
      if (match) await deleteDoc(match.ref);
    }
  }
}

// Handle Remove from Playlist button click
document
  .getElementById("pl-removeFromPlaylistBtn")
  ?.addEventListener("click", async () => {
    plSongPopup.classList.add("hidden");
    if (!currentUserId || !playlistId || !currentTrack) return;
    await removeTrackFromPlaylist(currentUserId, playlistId, currentTrack);
    // Remove row from DOM after deletion
    const rows = [...document.querySelectorAll(".song-item")];
    const row = rows.find(
      (r) =>
        r.querySelector(".song-title")?.textContent ===
        (currentTrack.name || currentTrack.title)
    );
    row?.parentElement?.nextElementSibling?.remove?.();
    row?.parentElement?.remove?.();
  });

// Back button -> return to home (genre view) or playlists page
backBtn?.addEventListener("click", () => {
  if (genre) {
    window.location.href = "home.html";
  } else {
    window.location.href = "playlists.html";
  }
});

// Handle Add to Playlist button (only visible in genre playlists)
document
  .getElementById("pl-addToPlaylistBtn")
  ?.addEventListener("click", async () => {
    plSongPopup.classList.add("hidden");

    // hand the selected track to jamendo.js and reuse its chooser
    if (typeof window.__bmSetCurrentTrack === "function") {
      window.__bmSetCurrentTrack(currentTrack);
    }
    if (typeof window.__bmAddToPlaylist === "function") {
      window.__bmAddToPlaylist();
    } else {
      alert("Add-to-playlist is unavailable on this page.");
    }
  });

/**
 * Track auth state and load playlist or genre content.
 */
auth.onAuthStateChanged(async (user) => {
  if (user) currentUserId = user.uid;

  if (genre) {
    await loadGenrePlaylist(genre);
    return;
  }

  if (!playlistId) {
    console.warn("No playlist id found");
    return;
  }
  if (user) {
    currentUserId = user.uid;
    await loadPlaylist(user.uid, playlistId);
  }
});

/**
 * Load a Firestore playlist (by user ID + playlist ID) and render its songs.
 * Falls back to subcollection if no array of songs is present.
 *
 * @async
 * @param {string} uid - User ID
 * @param {string} id - Playlist document ID
 * @returns {Promise&lt;void>}
 */
async function loadPlaylist(uid, id) {
  console.log("Loading playlists");
  const ref = doc(db, "users", uid, "playlists", id);
  const snap = await getDoc(ref);
  if (!snap.exists()) return;

  console.log(snap + "The snap is above");

  const data = snap.data();
  if (nameEl) nameEl.textContent = data.name || "Untitled Playlist";

  let songs = [];
  if (Array.isArray(data.songs) &amp;&amp; data.songs.length) {
    songs = data.songs;
  } else {
    const songsCol = collection(db, "users", uid, "playlists", id, "songs");
    const songsSnap = await getDocs(songsCol);
    songs = songsSnap.docs.map((d) => ({ id: d.id, ...d.data() }));
  }

  const cover =
    songs[0]?.album_image || songs[0]?.albumArt || songs[0]?.cover || "";
  if (iconEl) {
    if (cover) {
      iconEl.style.backgroundImage = `url(${cover})`;
      iconEl.style.backgroundColor = "transparent";
      iconEl.style.backgroundSize = "cover";
      iconEl.style.backgroundPosition = "center";
    } else {
      iconEl.style.backgroundImage = "none";
    }
  }
  console.log(songs);
  renderSongs(songs);
}

/**
 * Load a genre-based playlist (Jamendo top tracks).
 *
 * @async
 * @param {string} tag - Genre name (e.g., "rock", "jazz").
 * @returns {Promise&lt;void>}
 */
async function loadGenrePlaylist(tag) {
  const pretty = tag.charAt(0).toUpperCase() + tag.slice(1);
  nameEl.textContent = pretty;

  const songs = await getTopTracksByTag(tag, 10);

  const cover = songs[0]?.album_image || "";
  if (cover) {
    iconEl.style.backgroundImage = `url(${cover})`;
    iconEl.style.backgroundColor = "transparent";
    iconEl.style.backgroundSize = "cover";
    iconEl.style.backgroundPosition = "center";
  } else {
    iconEl.style.backgroundImage = "none";
  }

  renderSongs(songs);
}

/**
 * Render a list of songs into the playlist page.
 * Each row:
 *  - Displays cover, title, artist
 *  - Wires click → dispatches "play-request" event
 *  - Wires song-menu → opens popup for add/remove
 *
 * @param {Array&lt;Object>} songs - Songs to render.
 * @returns {void}
 */
function renderSongs(songs) {
  if (!songsWrap) return;
  songsWrap.innerHTML = "";

  songs.forEach((track, index) => {
    const wrapper = document.createElement("div");
    const row = document.createElement("div");
    row.className = "song-item";

    const title = track.name || track.title || "Unknown Title";
    const artist = track.artist_name || track.artist || "Unknown Artist";
    const cover = track.album_image || track.albumArt || track.cover || "";

    row.innerHTML = `
      &lt;div class="song-left">
        &lt;div class="song-thumb">
          &lt;img src="${
            cover || FALLBACK_IMG
          }" alt="" onerror="this.src='${FALLBACK_IMG}'">
        &lt;/div>
        &lt;div class="song-info">
          &lt;span class="song-title">${title}&lt;/span>
          &lt;span class="song-artist">${artist}&lt;/span>
        &lt;/div>
      &lt;/div>
      &lt;button class="song-menu">
        &lt;img class="more-icon" src="${
          import.meta.env.BASE_URL
        }Media/More-icon.svg">
      &lt;/button>
    `;

    wrapper.appendChild(row);
    const hr = document.createElement("hr");
    hr.classList.add("song-separator");

    songsWrap.appendChild(wrapper);
    songsWrap.appendChild(hr);

    // Open popup menu
    row.querySelector(".song-menu")?.addEventListener("click", (e) => {
      e.stopPropagation();
      openMorePopup(e.currentTarget, track);
    });

    // Dispatch play request
    row.addEventListener("click", () => {
      const event = new CustomEvent("play-request", {
        detail: {
          track: track,
          index: index,
          playlist: songs,
        },
      });
      window.dispatchEvent(event);
    });
  });
}
</code></pre>
        </article>
    </section>




</div>

<nav>
    <h2><a href="index.html">Home</a></h2><h3>Events</h3><ul><li><a href="window.html#event:play-request">play-request</a></li></ul><h3>Global</h3><ul><li><a href="global.html#CLIENT_ID">CLIENT_ID</a></li><li><a href="global.html#audioCtx">audioCtx</a></li><li><a href="global.html#auth">auth</a></li><li><a href="global.html#createPlaylist">createPlaylist</a></li><li><a href="global.html#createStarterPlaylist">createStarterPlaylist</a></li><li><a href="global.html#currentIndex">currentIndex</a></li><li><a href="global.html#currentPlaylist">currentPlaylist</a></li><li><a href="global.html#currentPlaylistId">currentPlaylistId</a></li><li><a href="global.html#currentTrack">currentTrack</a></li><li><a href="global.html#currentUserId">currentUserId</a></li><li><a href="global.html#db">db</a></li><li><a href="global.html#displayResults">displayResults</a></li><li><a href="global.html#drawBar">drawBar</a></li><li><a href="global.html#drawVisualizer">drawVisualizer</a></li><li><a href="global.html#formatTime">formatTime</a></li><li><a href="global.html#getFriendlyErrorMessage">getFriendlyErrorMessage</a></li><li><a href="global.html#getTopTracksByTag">getTopTracksByTag</a></li><li><a href="global.html#handleAddToPlaylist">handleAddToPlaylist</a></li><li><a href="global.html#handleRemoveFromPlaylist">handleRemoveFromPlaylist</a></li><li><a href="global.html#init">init</a></li><li><a href="global.html#initVisualizer">initVisualizer</a></li><li><a href="global.html#loadGenrePlaylist">loadGenrePlaylist</a></li><li><a href="global.html#loadPlaylist">loadPlaylist</a></li><li><a href="global.html#newPlaylistBtn">newPlaylistBtn</a></li><li><a href="global.html#openMorePopup">openMorePopup</a></li><li><a href="global.html#playTrack">playTrack</a></li><li><a href="global.html#playlistsContainer">playlistsContainer</a></li><li><a href="global.html#popupMenu">popupMenu</a></li><li><a href="global.html#qp">qp</a></li><li><a href="global.html#removeTrackFromPlaylist">removeTrackFromPlaylist</a></li><li><a href="global.html#renderPlaylists">renderPlaylists</a></li><li><a href="global.html#renderSongs">renderSongs</a></li><li><a href="global.html#resolveToEmail">resolveToEmail</a></li><li><a href="global.html#searchTracks">searchTracks</a></li><li><a href="global.html#songPopup">songPopup</a></li><li><a href="global.html#usernameDisplay">usernameDisplay</a></li></ul>
</nav>

<br class="clear">

<footer>
    Documentation generated by <a href="https://github.com/jsdoc/jsdoc">JSDoc 4.0.4</a> on Mon Sep 08 2025 11:24:55 GMT+0200 (Central European Summer Time)
</footer>

<script> prettyPrint(); </script>
<script src="scripts/linenumber.js"> </script>
</body>
</html>
