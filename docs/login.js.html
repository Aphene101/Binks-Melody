<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="utf-8">
    <title>JSDoc: Source: login.js</title>

    <script src="scripts/prettify/prettify.js"> </script>
    <script src="scripts/prettify/lang-css.js"> </script>
    <!--[if lt IE 9]>
      <script src="//html5shiv.googlecode.com/svn/trunk/html5.js"></script>
    <![endif]-->
    <link type="text/css" rel="stylesheet" href="styles/prettify-tomorrow.css">
    <link type="text/css" rel="stylesheet" href="styles/jsdoc-default.css">
</head>

<body>

<div id="main">

    <h1 class="page-title">Source: login.js</h1>

    



    
    <section>
        <article>
            <pre class="prettyprint source linenums"><code>/**
 * @file login.js
 * @description Handles user login, username-to-email resolution,
 * error handling, and password reset link requests for the app.
 */

import { auth } from "./firebase.js";
import {
  signInWithEmailAndPassword,
  signOut,
  sendPasswordResetEmail,
} from "firebase/auth";
import { getFirestore, doc, getDoc } from "firebase/firestore";
import { getApp } from "firebase/app";

const app = getApp();
const db = getFirestore(app);

/**
 * Convert Firebase Auth error codes into user-friendly messages.
 *
 * @param {Error &amp; {code?: string}} error - Firebase Auth error object.
 * @returns {string} Human-readable error message.
 */
function getFriendlyErrorMessage(error) {
  const code = error.code || error.message;

  switch (code) {
    case "auth/invalid-email":
      return "Please enter a valid email address.";
    case "auth/user-not-found":
      return "No account found with this email or username.";
    case "auth/invalid-credential":
      return "Email / Password is incorrect.";
    case "auth/user-disabled":
      return "This account has been disabled.";
    case "auth/email-not-verified":
      return "Please verify your email before logging in.";
    case "auth/too-many-requests":
      return "Too many failed attempts. Please try again later.";
    default:
      return error.message || "Something went wrong. Please try again.";
  }
}

/**
 * Resolve a login input (username or email) to a proper email address.
 *
 * @async
 * @param {string} inputValue - Either an email or a username.
 * @returns {Promise&lt;string>} A valid email address.
 * @throws {Error} If the username does not exist in Firestore.
 */
async function resolveToEmail(inputValue) {
  if (inputValue.includes("@")) {
    return inputValue;
  }

  const docRef = doc(db, "usernames", inputValue);
  const snap = await getDoc(docRef);

  if (snap.exists()) {
    return snap.data().email;
  } else {
    throw new Error("Username not found");
  }
}

document.addEventListener("DOMContentLoaded", () => {
  const loginInput = document.querySelector("#login-email");
  const passwordInput = document.querySelector("#login-password");
  const loginButton = document.querySelector("#login-button");
  const errorBox = document.querySelector("#login-error");
  const forgotLink = document.getElementById("forgot-password");

  if (!loginInput || !passwordInput || !loginButton || !errorBox) return;

  /**
   * Handle login button click -> attempt to sign in with email/password.
   */
  loginButton.addEventListener("click", async () => {
    const inputVal = loginInput.value.trim();
    const password = passwordInput.value;

    if (!inputVal || !password) {
      errorBox.textContent = "Please enter both fields.";
      return;
    }

    try {
      const email = await resolveToEmail(inputVal);

      const userCredential = await signInWithEmailAndPassword(
        auth,
        email,
        password
      );
      const user = userCredential.user;

      // Reject login if email not verified
      if (!user.emailVerified) {
        await signOut(auth);
        throw { code: "auth/email-not-verified" };
      }

      errorBox.textContent = "";

      window.location.href = "./home.html";
    } catch (err) {
      console.error("Login error:", err);
      const friendly = getFriendlyErrorMessage(err);
      errorBox.textContent = friendly;
    }
  });

  /**
   * Handle "Forgot Password?" link -> send reset email.
   */
  forgotLink?.addEventListener("click", async (e) => {
    e.preventDefault();
    try {
      let typed = loginInput?.value?.trim();

      if (!typed) {
        typed = window
          .prompt("Enter the email (or username) for your account:")
          ?.trim();
      }
      if (!typed) return;

      let email = typed;
      if (!typed.includes("@")) {
        try {
          email = await resolveToEmail(typed);
        } catch {}
      }

      const resetUrl = new URL(
        import.meta.env.BASE_URL + "reset.html",
        window.location.origin
      ).toString();
      const actionCodeSettings = { url: resetUrl, handleCodeInApp: false };

      await sendPasswordResetEmail(auth, email, actionCodeSettings);
      alert("If that account exists, a reset link has been sent.");
    } catch (err) {
      console.error(err);
      alert("If that account exists, a reset link has been sent.");
    }
  });
});
</code></pre>
        </article>
    </section>




</div>

<nav>
    <h2><a href="index.html">Home</a></h2><h3>Events</h3><ul><li><a href="window.html#event:play-request">play-request</a></li></ul><h3>Global</h3><ul><li><a href="global.html#CLIENT_ID">CLIENT_ID</a></li><li><a href="global.html#audioCtx">audioCtx</a></li><li><a href="global.html#auth">auth</a></li><li><a href="global.html#createPlaylist">createPlaylist</a></li><li><a href="global.html#createStarterPlaylist">createStarterPlaylist</a></li><li><a href="global.html#currentIndex">currentIndex</a></li><li><a href="global.html#currentPlaylist">currentPlaylist</a></li><li><a href="global.html#currentPlaylistId">currentPlaylistId</a></li><li><a href="global.html#currentTrack">currentTrack</a></li><li><a href="global.html#currentUserId">currentUserId</a></li><li><a href="global.html#db">db</a></li><li><a href="global.html#displayResults">displayResults</a></li><li><a href="global.html#drawBar">drawBar</a></li><li><a href="global.html#drawVisualizer">drawVisualizer</a></li><li><a href="global.html#formatTime">formatTime</a></li><li><a href="global.html#getFriendlyErrorMessage">getFriendlyErrorMessage</a></li><li><a href="global.html#getTopTracksByTag">getTopTracksByTag</a></li><li><a href="global.html#handleAddToPlaylist">handleAddToPlaylist</a></li><li><a href="global.html#handleRemoveFromPlaylist">handleRemoveFromPlaylist</a></li><li><a href="global.html#init">init</a></li><li><a href="global.html#initVisualizer">initVisualizer</a></li><li><a href="global.html#loadGenrePlaylist">loadGenrePlaylist</a></li><li><a href="global.html#loadPlaylist">loadPlaylist</a></li><li><a href="global.html#newPlaylistBtn">newPlaylistBtn</a></li><li><a href="global.html#openMorePopup">openMorePopup</a></li><li><a href="global.html#playTrack">playTrack</a></li><li><a href="global.html#playlistsContainer">playlistsContainer</a></li><li><a href="global.html#popupMenu">popupMenu</a></li><li><a href="global.html#qp">qp</a></li><li><a href="global.html#removeTrackFromPlaylist">removeTrackFromPlaylist</a></li><li><a href="global.html#renderPlaylists">renderPlaylists</a></li><li><a href="global.html#renderSongs">renderSongs</a></li><li><a href="global.html#resolveToEmail">resolveToEmail</a></li><li><a href="global.html#searchTracks">searchTracks</a></li><li><a href="global.html#songPopup">songPopup</a></li><li><a href="global.html#usernameDisplay">usernameDisplay</a></li></ul>
</nav>

<br class="clear">

<footer>
    Documentation generated by <a href="https://github.com/jsdoc/jsdoc">JSDoc 4.0.4</a> on Mon Sep 08 2025 11:24:55 GMT+0200 (Central European Summer Time)
</footer>

<script> prettyPrint(); </script>
<script src="scripts/linenumber.js"> </script>
</body>
</html>
